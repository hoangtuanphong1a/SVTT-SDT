/******************************
 *  Schema: Job Portal (SQL Server)
 *  Author: Generated by assistant
 ******************************/

SET NOCOUNT ON;
GO

-- ============================
-- 1. USERS / ROLES
-- ============================
CREATE TABLE dbo.Roles (
    RoleId INT IDENTITY(1,1) PRIMARY KEY,
    RoleName NVARCHAR(50) NOT NULL UNIQUE, -- e.g., JobSeeker, Employer, Admin
    Description NVARCHAR(255) NULL,
    CreatedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME()
);

CREATE TABLE dbo.Users (
    UserId INT IDENTITY(1,1) PRIMARY KEY,
    Email NVARCHAR(256) NOT NULL UNIQUE,
    PasswordHash NVARCHAR(512) NULL, -- null if social login only
    IsEmailConfirmed BIT NOT NULL DEFAULT 0,
    CreatedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
    LastLoginAt DATETIME2 NULL,
    IsActive BIT NOT NULL DEFAULT 1,
    IsDeleted BIT NOT NULL DEFAULT 0,
    DisplayName NVARCHAR(200) NULL,
    AvatarUrl NVARCHAR(1000) NULL,
    PreferredLocale NVARCHAR(20) NULL,
    -- for social auth
    GoogleId NVARCHAR(200) NULL,
    LinkedInId NVARCHAR(200) NULL
);

CREATE TABLE dbo.UserRoles (
    UserRoleId INT IDENTITY(1,1) PRIMARY KEY,
    UserId INT NOT NULL,
    RoleId INT NOT NULL,
    AssignedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
    CONSTRAINT FK_UserRoles_Users FOREIGN KEY (UserId) REFERENCES dbo.Users(UserId) ON DELETE CASCADE,
    CONSTRAINT FK_UserRoles_Roles FOREIGN KEY (RoleId) REFERENCES dbo.Roles(RoleId)
);

-- ============================
-- 2. COMPANIES & EMPLOYERS
-- ============================
CREATE TABLE dbo.Companies (
    CompanyId INT IDENTITY(1,1) PRIMARY KEY,
    Name NVARCHAR(300) NOT NULL,
    Slug NVARCHAR(300) NOT NULL UNIQUE,
    LogoUrl NVARCHAR(1000) NULL,
    BannerUrl NVARCHAR(1000) NULL,
    Industry NVARCHAR(200) NULL,
    CompanySize NVARCHAR(50) NULL,
    Website NVARCHAR(500) NULL,
    Location NVARCHAR(300) NULL,
    Description NVARCHAR(MAX) NULL,
    IsVerified BIT NOT NULL DEFAULT 0,
    CreatedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
    UpdatedAt DATETIME2 NULL
);

CREATE TABLE dbo.EmployerProfiles (
    EmployerProfileId INT IDENTITY(1,1) PRIMARY KEY,
    UserId INT NOT NULL, -- the user account who manages this company
    CompanyId INT NOT NULL,
    Title NVARCHAR(200) NULL, -- role/title of that user in company
    Phone NVARCHAR(50) NULL,
    CreatedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
    CONSTRAINT FK_EmployerProfiles_Users FOREIGN KEY (UserId) REFERENCES dbo.Users(UserId) ON DELETE CASCADE,
    CONSTRAINT FK_EmployerProfiles_Companies FOREIGN KEY (CompanyId) REFERENCES dbo.Companies(CompanyId) ON DELETE CASCADE
);

-- ============================
-- 3. JOB SEEKER PROFILE
-- ============================
CREATE TABLE dbo.JobSeekerProfiles (
    JobSeekerProfileId INT IDENTITY(1,1) PRIMARY KEY,
    UserId INT NOT NULL UNIQUE,
    FullName NVARCHAR(300) NULL,
    Phone NVARCHAR(50) NULL,
    DOB DATE NULL,
    Location NVARCHAR(300) NULL,
    Summary NVARCHAR(MAX) NULL,
    CurrentTitle NVARCHAR(200) NULL,
    YearsExperience INT NULL,
    CreatedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
    UpdatedAt DATETIME2 NULL,
    CONSTRAINT FK_JobSeekerProfiles_Users FOREIGN KEY (UserId) REFERENCES dbo.Users(UserId) ON DELETE CASCADE
);

-- ============================
-- 4. CV TEMPLATES & CVs
-- ============================
CREATE TABLE dbo.CVTemplates (
    CVTemplateId INT IDENTITY(1,1) PRIMARY KEY,
    Name NVARCHAR(200) NOT NULL,
    Slug NVARCHAR(200) NOT NULL UNIQUE,
    Description NVARCHAR(500) NULL,
    LayoutMeta NVARCHAR(MAX) NULL, -- JSON describing layout, colors, sections etc.
    IsPublic BIT NOT NULL DEFAULT 1,
    CreatedBy INT NULL, -- FK to Users (creator)
    CreatedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
    CONSTRAINT FK_CVTemplates_CreatedBy FOREIGN KEY (CreatedBy) REFERENCES dbo.Users(UserId) ON DELETE SET NULL
);

CREATE TABLE dbo.CVs (
    CVId INT IDENTITY(1,1) PRIMARY KEY,
    JobSeekerProfileId INT NOT NULL,
    CVTemplateId INT NULL,
    Title NVARCHAR(250) NULL,
    StructuredData NVARCHAR(MAX) NULL, -- JSON: sections (education, exp, skills, projects)
    FileUrl NVARCHAR(1000) NULL, -- uploaded PDF path
    IsPrimary BIT NOT NULL DEFAULT 0,
    IsPublic BIT NOT NULL DEFAULT 0,
    CreatedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
    UpdatedAt DATETIME2 NULL,
    CONSTRAINT FK_CVs_JobSeekerProfiles FOREIGN KEY (JobSeekerProfileId) REFERENCES dbo.JobSeekerProfiles(JobSeekerProfileId) ON DELETE CASCADE,
    CONSTRAINT FK_CVs_CVTemplates FOREIGN KEY (CVTemplateId) REFERENCES dbo.CVTemplates(CVTemplateId) ON DELETE SET NULL
);

-- ============================
-- 5. JOBS, CATEGORIES, TAGS, SKILLS
-- ============================
CREATE TABLE dbo.JobCategories (
    JobCategoryId INT IDENTITY(1,1) PRIMARY KEY,
    Name NVARCHAR(200) NOT NULL UNIQUE
);

CREATE TABLE dbo.JobTags (
    JobTagId INT IDENTITY(1,1) PRIMARY KEY,
    Name NVARCHAR(200) NOT NULL UNIQUE
);

CREATE TABLE dbo.Skills (
    SkillId INT IDENTITY(1,1) PRIMARY KEY,
    Name NVARCHAR(200) NOT NULL UNIQUE
);

CREATE TABLE dbo.Jobs (
    JobId INT IDENTITY(1,1) PRIMARY KEY,
    CompanyId INT NOT NULL,
    PostedByUserId INT NULL, -- which employer user created it
    Title NVARCHAR(300) NOT NULL,
    Slug NVARCHAR(300) NOT NULL UNIQUE,
    ShortDescription NVARCHAR(1000) NULL,
    Description NVARCHAR(MAX) NULL,
    Requirements NVARCHAR(MAX) NULL,
    Benefits NVARCHAR(MAX) NULL,
    SalaryMin INT NULL,
    SalaryMax INT NULL,
    Currency NVARCHAR(10) NULL,
    JobType NVARCHAR(50) NULL, -- Full-time, Part-time, Internship...
    Location NVARCHAR(300) NULL,
    CategoryId INT NULL,
    Status NVARCHAR(50) NOT NULL DEFAULT 'Active', -- Active, Draft, Expired, Closed
    ViewsCount INT NOT NULL DEFAULT 0,
    PostedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
    ExpiresAt DATETIME2 NULL,
    CreatedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
    UpdatedAt DATETIME2 NULL,
    CONSTRAINT FK_Jobs_Companies FOREIGN KEY (CompanyId) REFERENCES dbo.Companies(CompanyId) ON DELETE CASCADE,
    CONSTRAINT FK_Jobs_PostedByUser FOREIGN KEY (PostedByUserId) REFERENCES dbo.Users(UserId) ON DELETE SET NULL,
    CONSTRAINT FK_Jobs_Category FOREIGN KEY (CategoryId) REFERENCES dbo.JobCategories(JobCategoryId) ON DELETE SET NULL
);

-- Many-to-many Jobs <-> Skills
CREATE TABLE dbo.JobSkills (
    JobSkillId INT IDENTITY(1,1) PRIMARY KEY,
    JobId INT NOT NULL,
    SkillId INT NOT NULL,
    CONSTRAINT FK_JobSkills_Jobs FOREIGN KEY (JobId) REFERENCES dbo.Jobs(JobId) ON DELETE CASCADE,
    CONSTRAINT FK_JobSkills_Skills FOREIGN KEY (SkillId) REFERENCES dbo.Skills(SkillId) ON DELETE CASCADE
);

-- Many-to-many Jobs <-> Tags
CREATE TABLE dbo.JobJobTags (
    JobJobTagId INT IDENTITY(1,1) PRIMARY KEY,
    JobId INT NOT NULL,
    JobTagId INT NOT NULL,
    CONSTRAINT FK_JobJobTags_Jobs FOREIGN KEY (JobId) REFERENCES dbo.Jobs(JobId) ON DELETE CASCADE,
    CONSTRAINT FK_JobJobTags_JobTags FOREIGN KEY (JobTagId) REFERENCES dbo.JobTags(JobTagId) ON DELETE CASCADE
);

-- ============================
-- 6. APPLICATIONS, SAVED JOBS
-- ============================
CREATE TABLE dbo.JobApplications (
    ApplicationId INT IDENTITY(1,1) PRIMARY KEY,
    JobId INT NOT NULL,
    JobSeekerProfileId INT NOT NULL,
    CVId INT NULL,
    CoverLetter NVARCHAR(MAX) NULL,
    Status NVARCHAR(50) NOT NULL DEFAULT 'Pending', -- Pending, Reviewed, Interview, Rejected, Hired
    AppliedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
    UpdatedAt DATETIME2 NULL,
    IsDeleted BIT NOT NULL DEFAULT 0,
    CONSTRAINT FK_JobApplications_Jobs FOREIGN KEY (JobId) REFERENCES dbo.Jobs(JobId) ON DELETE CASCADE,
    CONSTRAINT FK_JobApplications_JobSeekerProfiles FOREIGN KEY (JobSeekerProfileId) REFERENCES dbo.JobSeekerProfiles(JobSeekerProfileId) ON DELETE CASCADE,
    CONSTRAINT FK_JobApplications_CVs FOREIGN KEY (CVId) REFERENCES dbo.CVs(CVId) ON DELETE SET NULL
);

CREATE TABLE dbo.SavedJobs (
    SavedJobId INT IDENTITY(1,1) PRIMARY KEY,
    JobSeekerProfileId INT NOT NULL,
    JobId INT NOT NULL,
    SavedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
    CONSTRAINT UQ_SavedJobs UNIQUE (JobSeekerProfileId, JobId),
    CONSTRAINT FK_SavedJobs_JobSeekerProfiles FOREIGN KEY (JobSeekerProfileId) REFERENCES dbo.JobSeekerProfiles(JobSeekerProfileId) ON DELETE CASCADE,
    CONSTRAINT FK_SavedJobs_Jobs FOREIGN KEY (JobId) REFERENCES dbo.Jobs(JobId) ON DELETE CASCADE
);

-- ============================
-- 7. SUBSCRIPTIONS / BILLING (employers)
-- ============================
CREATE TABLE dbo.SubscriptionPlans (
    PlanId INT IDENTITY(1,1) PRIMARY KEY,
    Name NVARCHAR(200) NOT NULL,
    Price DECIMAL(18,2) NOT NULL,
    Currency NVARCHAR(10) NOT NULL DEFAULT 'USD',
    Features NVARCHAR(MAX) NULL, -- JSON or comma-separated
    DurationDays INT NOT NULL,
    CreatedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME()
);

CREATE TABLE dbo.EmployerSubscriptions (
    EmployerSubscriptionId INT IDENTITY(1,1) PRIMARY KEY,
    CompanyId INT NOT NULL,
    PlanId INT NOT NULL,
    StartedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
    ExpiresAt DATETIME2 NOT NULL,
    IsActive BIT NOT NULL DEFAULT 1,
    CONSTRAINT FK_EmployerSubscriptions_Companies FOREIGN KEY (CompanyId) REFERENCES dbo.Companies(CompanyId) ON DELETE CASCADE,
    CONSTRAINT FK_EmployerSubscriptions_Plans FOREIGN KEY (PlanId) REFERENCES dbo.SubscriptionPlans(PlanId)
);

-- ============================
-- 8. NOTIFICATIONS
-- ============================
CREATE TABLE dbo.Notifications (
    NotificationId INT IDENTITY(1,1) PRIMARY KEY,
    UserId INT NOT NULL,
    Title NVARCHAR(250) NOT NULL,
    Message NVARCHAR(MAX) NOT NULL,
    IsRead BIT NOT NULL DEFAULT 0,
    Link NVARCHAR(1000) NULL, -- deep link
    CreatedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
    CONSTRAINT FK_Notifications_Users FOREIGN KEY (UserId) REFERENCES dbo.Users(UserId) ON DELETE CASCADE
);

-- ============================
-- 9. MESSAGING
-- ============================
-- Thread between two or more users (for extensibility)
CREATE TABLE dbo.MessageThreads (
    ThreadId UNIQUEIDENTIFIER DEFAULT NEWID() PRIMARY KEY,
    Subject NVARCHAR(500) NULL,
    CreatedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME()
);

CREATE TABLE dbo.ThreadParticipants (
    ThreadParticipantId INT IDENTITY(1,1) PRIMARY KEY,
    ThreadId UNIQUEIDENTIFIER NOT NULL,
    UserId INT NOT NULL,
    JoinedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
    IsMuted BIT NOT NULL DEFAULT 0,
    CONSTRAINT FK_ThreadParticipants_Thread FOREIGN KEY (ThreadId) REFERENCES dbo.MessageThreads(ThreadId) ON DELETE CASCADE,
    CONSTRAINT FK_ThreadParticipants_User FOREIGN KEY (UserId) REFERENCES dbo.Users(UserId) ON DELETE CASCADE
);

CREATE TABLE dbo.Messages (
    MessageId INT IDENTITY(1,1) PRIMARY KEY,
    ThreadId UNIQUEIDENTIFIER NOT NULL,
    SenderUserId INT NOT NULL,
    Body NVARCHAR(MAX) NOT NULL,
    SentAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
    IsRead BIT NOT NULL DEFAULT 0,
    AttachmentUrl NVARCHAR(1000) NULL,
    CONSTRAINT FK_Messages_Thread FOREIGN KEY (ThreadId) REFERENCES dbo.MessageThreads(ThreadId) ON DELETE CASCADE,
    CONSTRAINT FK_Messages_Sender FOREIGN KEY (SenderUserId) REFERENCES dbo.Users(UserId) ON DELETE CASCADE
);

-- ============================
-- 10. BLOG
-- ============================
CREATE TABLE dbo.BlogPosts (
    BlogPostId INT IDENTITY(1,1) PRIMARY KEY,
    Title NVARCHAR(500) NOT NULL,
    Slug NVARCHAR(500) NOT NULL UNIQUE,
    Content NVARCHAR(MAX) NOT NULL,
    Excerpt NVARCHAR(1000) NULL,
    CoverImageUrl NVARCHAR(1000) NULL,
    AuthorUserId INT NOT NULL,
    IsPublished BIT NOT NULL DEFAULT 0,
    PublishedAt DATETIME2 NULL,
    CreatedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
    UpdatedAt DATETIME2 NULL,
    CONSTRAINT FK_BlogPosts_Author FOREIGN KEY (AuthorUserId) REFERENCES dbo.Users(UserId) ON DELETE SET NULL
);

CREATE TABLE dbo.BlogTags (
    BlogTagId INT IDENTITY(1,1) PRIMARY KEY,
    Name NVARCHAR(200) NOT NULL UNIQUE
);

CREATE TABLE dbo.BlogPostTags (
    BlogPostTagId INT IDENTITY(1,1) PRIMARY KEY,
    BlogPostId INT NOT NULL,
    BlogTagId INT NOT NULL,
    CONSTRAINT FK_BlogPostTags_BlogPosts FOREIGN KEY (BlogPostId) REFERENCES dbo.BlogPosts(BlogPostId) ON DELETE CASCADE,
    CONSTRAINT FK_BlogPostTags_BlogTags FOREIGN KEY (BlogTagId) REFERENCES dbo.BlogTags(BlogTagId) ON DELETE CASCADE
);

CREATE TABLE dbo.BlogComments (
    CommentId INT IDENTITY(1,1) PRIMARY KEY,
    BlogPostId INT NOT NULL,
    UserId INT NULL,
    GuestName NVARCHAR(200) NULL,
    Content NVARCHAR(MAX) NOT NULL,
    IsApproved BIT NOT NULL DEFAULT 0,
    CreatedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
    CONSTRAINT FK_BlogComments_BlogPosts FOREIGN KEY (BlogPostId) REFERENCES dbo.BlogPosts(BlogPostId) ON DELETE CASCADE,
    CONSTRAINT FK_BlogComments_Users FOREIGN KEY (UserId) REFERENCES dbo.Users(UserId) ON DELETE SET NULL
);

-- ============================
-- 11. TRACKING / ANALYTICS
-- ============================
CREATE TABLE dbo.JobViews (
    JobViewId INT IDENTITY(1,1) PRIMARY KEY,
    JobId INT NOT NULL,
    ViewerUserId INT NULL,
    SessionId NVARCHAR(200) NULL,
    ViewedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
    CONSTRAINT FK_JobViews_Jobs FOREIGN KEY (JobId) REFERENCES dbo.Jobs(JobId) ON DELETE CASCADE,
    CONSTRAINT FK_JobViews_Users FOREIGN KEY (ViewerUserId) REFERENCES dbo.Users(UserId) ON DELETE SET NULL
);

CREATE TABLE dbo.CVViews (
    CVViewId INT IDENTITY(1,1) PRIMARY KEY,
    CVId INT NOT NULL,
    ViewerUserId INT NULL,
    ViewedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
    CONSTRAINT FK_CVViews_CVs FOREIGN KEY (CVId) REFERENCES dbo.CVs(CVId) ON DELETE CASCADE,
    CONSTRAINT FK_CVViews_Users FOREIGN KEY (ViewerUserId) REFERENCES dbo.Users(UserId) ON DELETE SET NULL
);

CREATE TABLE dbo.ApplicationEvents (
    ApplicationEventId INT IDENTITY(1,1) PRIMARY KEY,
    ApplicationId INT NOT NULL,
    EventType NVARCHAR(100) NOT NULL, -- e.g., "StatusChanged", "ViewedByEmployer"
    EventData NVARCHAR(MAX) NULL, -- JSON details
    CreatedAt DATETIME2 NOT NULL DEFAULT SYSUTCDATETIME(),
    CONSTRAINT FK_ApplicationEvents_Applications FOREIGN KEY (ApplicationId) REFERENCES dbo.JobApplications(ApplicationId) ON DELETE CASCADE
);

-- ============================
-- 12. Indexes & Full-Text suggestions
-- ============================
-- Indexes for frequent lookups
CREATE INDEX IX_Users_Email ON dbo.Users(Email);
CREATE INDEX IX_Jobs_Title_Location ON dbo.Jobs(Title, Location);
CREATE INDEX IX_Jobs_Status_PostedAt ON dbo.Jobs(Status, PostedAt);
CREATE INDEX IX_JobApplications_JobId ON dbo.JobApplications(JobId);
CREATE INDEX IX_JobApplications_JobSeeker ON dbo.JobApplications(JobSeekerProfileId);
CREATE INDEX IX_CVs_JobSeeker ON dbo.CVs(JobSeekerProfileId);

-- NOTE: For full-text search on Jobs.Description, Jobs.Title, CV.StructuredData:
-- You should enable Full-Text Search in SQL Server instance and create full-text indexes:
-- Example:
-- CREATE FULLTEXT CATALOG ftCatalog AS DEFAULT;
-- CREATE FULLTEXT INDEX ON dbo.Jobs(Title, Description) KEY INDEX PK__Jobs__...;
-- CREATE FULLTEXT INDEX ON dbo.CVs(StructuredData) KEY INDEX PK__CVs__...;

-- ============================
-- 13. Sample Stored Procedures (basic)
-- ============================
/* 1) Create user */
CREATE PROCEDURE dbo.sp_CreateUser
    @Email NVARCHAR(256),
    @PasswordHash NVARCHAR(512),
    @DisplayName NVARCHAR(200) = NULL,
    @OutUserId INT OUTPUT
AS
BEGIN
    SET NOCOUNT ON;
    INSERT INTO dbo.Users (Email, PasswordHash, DisplayName, CreatedAt)
    VALUES (@Email, @PasswordHash, @DisplayName, SYSUTCDATETIME());
    SET @OutUserId = SCOPE_IDENTITY();
END;
GO

/* 2) Post a job */
CREATE PROCEDURE dbo.sp_PostJob
    @CompanyId INT,
    @PostedByUserId INT,
    @Title NVARCHAR(300),
    @Slug NVARCHAR(300),
    @ShortDescription NVARCHAR(1000) = NULL,
    @Description NVARCHAR(MAX) = NULL,
    @Requirements NVARCHAR(MAX) = NULL,
    @Benefits NVARCHAR(MAX) = NULL,
    @SalaryMin INT = NULL,
    @SalaryMax INT = NULL,
    @JobType NVARCHAR(50) = NULL,
    @Location NVARCHAR(300) = NULL,
    @CategoryId INT = NULL,
    @ExpiresAt DATETIME2 = NULL,
    @OutJobId INT OUTPUT
AS
BEGIN
    SET NOCOUNT ON;
    INSERT INTO dbo.Jobs
    (CompanyId, PostedByUserId, Title, Slug, ShortDescription, Description, Requirements, Benefits, SalaryMin, SalaryMax, JobType, Location, CategoryId, ExpiresAt, PostedAt, CreatedAt)
    VALUES
    (@CompanyId, @PostedByUserId, @Title, @Slug, @ShortDescription, @Description, @Requirements, @Benefits, @SalaryMin, @SalaryMax, @JobType, @Location, @CategoryId, @ExpiresAt, SYSUTCDATETIME(), SYSUTCDATETIME());

    SET @OutJobId = SCOPE_IDENTITY();
END;
GO

/* 3) Apply to a job */
CREATE PROCEDURE dbo.sp_ApplyToJob
    @JobId INT,
    @JobSeekerProfileId INT,
    @CVId INT = NULL,
    @CoverLetter NVARCHAR(MAX) = NULL,
    @OutApplicationId INT OUTPUT
AS
BEGIN
    SET NOCOUNT ON;
    INSERT INTO dbo.JobApplications (JobId, JobSeekerProfileId, CVId, CoverLetter, AppliedAt)
    VALUES (@JobId, @JobSeekerProfileId, @CVId, @CoverLetter, SYSUTCDATETIME());
    SET @OutApplicationId = SCOPE_IDENTITY();

    -- record analytics
    INSERT INTO dbo.ApplicationEvents (ApplicationId, EventType, EventData, CreatedAt)
    VALUES (@OutApplicationId, 'Applied', NULL, SYSUTCDATETIME());
END;
GO

/* 4) Basic CV search by skills/name (example using LIKE on structured JSON) 
   For production, use Full-Text Search or external search (Elasticsearch). */
CREATE PROCEDURE dbo.sp_SearchCVs
    @Keyword NVARCHAR(200) = NULL, -- could be name or skill
    @Location NVARCHAR(200) = NULL,
    @Page INT = 1,
    @PageSize INT = 20
AS
BEGIN
    SET NOCOUNT ON;
    DECLARE @Offset INT = (@Page - 1) * @PageSize;

    SELECT c.CVId, js.FullName, js.Location, c.Title, c.FileUrl, c.StructuredData
    FROM dbo.CVs c
    INNER JOIN dbo.JobSeekerProfiles js ON c.JobSeekerProfileId = js.JobSeekerProfileId
    WHERE ( @Keyword IS NULL OR (c.StructuredData LIKE '%' + @Keyword + '%' OR js.FullName LIKE '%' + @Keyword + '%') )
      AND ( @Location IS NULL OR js.Location LIKE '%' + @Location + '%' )
    ORDER BY c.CreatedAt DESC
    OFFSET @Offset ROWS FETCH NEXT @PageSize ROWS ONLY;
END;
GO

-- ============================
-- 14. Seed Data (basic)
-- ============================
-- Roles
INSERT INTO dbo.Roles (RoleName, Description) VALUES ('JobSeeker', 'Job seeker / candidate');
INSERT INTO dbo.Roles (RoleName, Description) VALUES ('Employer', 'Company employer account');
INSERT INTO dbo.Roles (RoleName, Description) VALUES ('Admin', 'Administrator');

-- Sample users
DECLARE @u1 INT, @u2 INT, @u3 INT;
EXEC dbo.sp_CreateUser @Email='alice@example.com', @PasswordHash='hash1', @DisplayName='Alice Nguyen', @OutUserId=@u1 OUTPUT;
EXEC dbo.sp_CreateUser @Email='hr@acme.com', @PasswordHash='hash2', @DisplayName='Acme HR', @OutUserId=@u2 OUTPUT;
EXEC dbo.sp_CreateUser @Email='admin@example.com', @PasswordHash='hash3', @DisplayName='Site Admin', @OutUserId=@u3 OUTPUT;

-- Assign roles
INSERT INTO dbo.UserRoles (UserId, RoleId) VALUES (@u1, (SELECT RoleId FROM dbo.Roles WHERE RoleName='JobSeeker'));
INSERT INTO dbo.UserRoles (UserId, RoleId) VALUES (@u2, (SELECT RoleId FROM dbo.Roles WHERE RoleName='Employer'));
INSERT INTO dbo.UserRoles (UserId, RoleId) VALUES (@u3, (SELECT RoleId FROM dbo.Roles WHERE RoleName='Admin'));

-- Job seeker profile
INSERT INTO dbo.JobSeekerProfiles (UserId, FullName, Phone, Location, Summary, CurrentTitle, YearsExperience)
VALUES (@u1, 'Alice Nguyen', '0123456789', 'Hanoi, Vietnam', 'Frontend dev with 3 years experience', 'Frontend Developer', 3);

-- Company + employer profile
INSERT INTO dbo.Companies (Name, Slug, Industry, CompanySize, Website, Location, Description, IsVerified)
VALUES ('Acme Corp', 'acme-corp', 'Software', '51-200', 'https://acme.example', 'Hanoi, Vietnam', 'Acme is a software company.', 1);

INSERT INTO dbo.EmployerProfiles (UserId, CompanyId, Title, Phone)
VALUES (@u2, (SELECT TOP 1 CompanyId FROM dbo.Companies WHERE Name='Acme Corp'), 'HR Manager', '0987654321');

-- Sample CV template
INSERT INTO dbo.CVTemplates (Name, Slug, Description, LayoutMeta, CreatedBy)
VALUES ('Simple Professional', 'simple-professional', 'A clean one-column CV', N'{"columns":1,"accent":"#f26b38"}', @u3);

-- Sample CV
INSERT INTO dbo.CVs (JobSeekerProfileId, CVTemplateId, Title, StructuredData, FileUrl, IsPrimary)
VALUES (
   (SELECT JobSeekerProfileId FROM dbo.JobSeekerProfiles WHERE UserId=@u1),
   (SELECT CVTemplateId FROM dbo.CVTemplates WHERE Slug='simple-professional'),
   'Alice CV - Frontend Dev',
   N'{"education":[{"school":"HUST","degree":"BSc CS","from":"2015","to":"2019"}],"experience":[{"company":"Acme","title":"Frontend","from":"2020","to":"2023","desc":"..."}],"skills":["JavaScript","React","CSS"]}',
   NULL,
   1
);

-- Sample job category, skill, job
INSERT INTO dbo.JobCategories (Name) VALUES ('Software Engineering');
INSERT INTO dbo.Skills (Name) VALUES ('React');
INSERT INTO dbo.JobTags (Name) VALUES ('Remote');

DECLARE @jobId INT;
EXEC dbo.sp_PostJob
    @CompanyId = (SELECT CompanyId FROM dbo.Companies WHERE Name='Acme Corp'),
    @PostedByUserId = @u2,
    @Title = 'Frontend Developer',
    @Slug = 'frontend-developer-acme',
    @ShortDescription = 'Frontend dev with React experience',
    @Description = 'Full job description goes here',
    @Requirements = '3+ years React',
    @Benefits = 'Health insurance',
    @SalaryMin=800, @SalaryMax=1500, @JobType='Full-time', @Location='Hanoi, Vietnam',
    @CategoryId = (SELECT JobCategoryId FROM dbo.JobCategories WHERE Name='Software Engineering'),
    @ExpiresAt = DATEADD(DAY, 30, SYSUTCDATETIME()),
    @OutJobId = @jobId OUTPUT;

-- link skill & tag
INSERT INTO dbo.JobSkills (JobId, SkillId) VALUES (@jobId, (SELECT SkillId FROM dbo.Skills WHERE Name='React'));
INSERT INTO dbo.JobJobTags (JobId, JobTagId) VALUES (@jobId, (SELECT JobTagId FROM dbo.JobTags WHERE Name='Remote'));

-- Sample subscription plan
INSERT INTO dbo.SubscriptionPlans (Name, Price, Currency, Features, DurationDays)
VALUES ('Basic Employer', 0.00, 'USD', N'{"posts":3,"cv_search":false}', 30);

-- Employer subscription
INSERT INTO dbo.EmployerSubscriptions (CompanyId, PlanId, StartedAt, ExpiresAt, IsActive)
VALUES ((SELECT CompanyId FROM dbo.Companies WHERE Name='Acme Corp'),
        (SELECT PlanId FROM dbo.SubscriptionPlans WHERE Name='Basic Employer'),
        SYSUTCDATETIME(), DATEADD(DAY, 30, SYSUTCDATETIME()), 1);

GO
